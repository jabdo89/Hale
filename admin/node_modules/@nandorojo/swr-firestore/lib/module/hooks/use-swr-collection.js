var _interopRequireWildcard=require("@babel/runtime/helpers/interopRequireWildcard");var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.useCollection=exports.getCollection=void 0;var _objectWithoutProperties2=_interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties"));var _toConsumableArray2=_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));var _slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator"));var _defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));var _swr=_interopRequireWildcard(require("swr"));var _context4=require("../context");var _react=require("react");var _empty=require("../helpers/empty");var _Cache=require("../classes/Cache");var _isDev=require("../helpers/is-dev");var _docDateParser=require("../helpers/doc-date-parser");function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);if(enumerableOnly)symbols=symbols.filter(function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable;});keys.push.apply(keys,symbols);}return keys;}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};if(i%2){ownKeys(Object(source),true).forEach(function(key){(0,_defineProperty2.default)(target,key,source[key]);});}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(target,Object.getOwnPropertyDescriptors(source));}else{ownKeys(Object(source)).forEach(function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key));});}}return target;}var getCollection=function getCollection(path){var query,_ref,parseDates,ignoreFirestoreDocumentSnapshotField,ref,data,_args=arguments;return _regenerator.default.async(function getCollection$(_context){while(1){switch(_context.prev=_context.next){case 0:query=_args.length>1&&_args[1]!==undefined?_args[1]:{};_ref=_args.length>2&&_args[2]!==undefined?_args[2]:_empty.empty.object,parseDates=_ref.parseDates,ignoreFirestoreDocumentSnapshotField=_ref.ignoreFirestoreDocumentSnapshotField;ref=createFirestoreRef(path,query);_context.next=5;return _regenerator.default.awrap(ref.get().then(function(querySnapshot){var array=[];querySnapshot.forEach(function(doc){var _doc$data;var docData=(_doc$data=doc.data({serverTimestamps:'estimate'}))!==null&&_doc$data!==void 0?_doc$data:_empty.empty.object;var docToAdd=(0,_docDateParser.withDocumentDatesParsed)(_objectSpread({},docData,{id:doc.id,exists:doc.exists,hasPendingWrites:doc.metadata.hasPendingWrites,__snapshot:ignoreFirestoreDocumentSnapshotField?undefined:doc}),parseDates);(0,_swr.mutate)(doc.ref.path,docToAdd,false);if(_isDev.isDev&&(docData.exists||docData.id||docData.hasPendingWrites)){console.warn('[get-collection] warning: Your document, ',doc.id,' is using one of the following reserved fields: [exists, id, hasPendingWrites]. These fields are reserved. Please remove them from your documents.');}array.push(docToAdd);});return array;}));case 5:data=_context.sent;return _context.abrupt("return",data);case 7:case"end":return _context.stop();}}},null,null,null,Promise);};exports.getCollection=getCollection;var createFirestoreRef=function createFirestoreRef(path,_ref2){var where=_ref2.where,orderBy=_ref2.orderBy,limit=_ref2.limit,startAt=_ref2.startAt,endAt=_ref2.endAt,startAfter=_ref2.startAfter,endBefore=_ref2.endBefore,isCollectionGroup=_ref2.isCollectionGroup;var ref=_context4.fuego.db.collection(path);if(isCollectionGroup){ref=_context4.fuego.db.collectionGroup(path);}if(where){function multipleConditions(w){return!!w&&Array.isArray(w[0]);}if(multipleConditions(where)){where.forEach(function(w){ref=ref.where(w[0],w[1],w[2]);});}else if(typeof where[0]==='string'&&typeof where[1]==='string'){ref=ref.where(where[0],where[1],where[2]);}}if(orderBy){if(typeof orderBy==='string'){ref=ref.orderBy(orderBy);}else if(Array.isArray(orderBy)){function multipleOrderBy(o){return Array.isArray(o[0]);}if(multipleOrderBy(orderBy)){orderBy.forEach(function(_ref3){var _ref4=(0,_slicedToArray2.default)(_ref3,2),order=_ref4[0],direction=_ref4[1];ref=ref.orderBy(order,direction);});}else{var _orderBy=(0,_slicedToArray2.default)(orderBy,2),order=_orderBy[0],direction=_orderBy[1];ref=ref.orderBy(order,direction);}}}if(startAt){ref=ref.startAt(startAt);}if(endAt){ref=ref.endAt(endAt);}if(startAfter){ref=ref.startAfter(startAfter);}if(endBefore){ref=ref.endBefore(endBefore);}if(limit){ref=ref.limit(limit);}return ref;};var createListenerAsync=function createListenerAsync(path,queryString,_ref5){var parseDates,_ref5$ignoreFirestore,ignoreFirestoreDocumentSnapshotField;return _regenerator.default.async(function createListenerAsync$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:parseDates=_ref5.parseDates,_ref5$ignoreFirestore=_ref5.ignoreFirestoreDocumentSnapshotField,ignoreFirestoreDocumentSnapshotField=_ref5$ignoreFirestore===void 0?true:_ref5$ignoreFirestore;return _context2.abrupt("return",new Promise(function(resolve){var _JSON$parse;var query=(_JSON$parse=JSON.parse(queryString))!==null&&_JSON$parse!==void 0?_JSON$parse:{};var ref=createFirestoreRef(path,query);var unsubscribe=ref.onSnapshot({includeMetadataChanges:true},function(querySnapshot){var data=[];querySnapshot.forEach(function(doc){var _doc$data2;var docData=(_doc$data2=doc.data({serverTimestamps:'estimate'}))!==null&&_doc$data2!==void 0?_doc$data2:_empty.empty.object;var docToAdd=(0,_docDateParser.withDocumentDatesParsed)(_objectSpread({},docData,{id:doc.id,exists:doc.exists,hasPendingWrites:doc.metadata.hasPendingWrites,__snapshot:ignoreFirestoreDocumentSnapshotField?undefined:doc}),parseDates);if(_isDev.isDev&&(docData.exists||docData.id||docData.hasPendingWrites)){console.warn('[use-collection] warning: Your document, ',doc.id,' is using one of the following reserved fields: [exists, id, hasPendingWrites]. These fields are reserved. Please remove them from your documents.');}(0,_swr.mutate)(doc.ref.path,docToAdd,false);data.push(docToAdd);});resolve({initialData:data,unsubscribe:unsubscribe});(0,_swr.mutate)([path,queryString],data,false);});}));case 2:case"end":return _context2.stop();}}},null,null,null,Promise);};var useCollection=function useCollection(path){var query=arguments.length>1&&arguments[1]!==undefined?arguments[1]:_empty.empty.object;var options=arguments.length>2&&arguments[2]!==undefined?arguments[2]:_empty.empty.object;var unsubscribeRef=(0,_react.useRef)(null);var where=query.where,endAt=query.endAt,endBefore=query.endBefore,startAfter=query.startAfter,startAt=query.startAt,orderBy=query.orderBy,limit=query.limit,_query$listen=query.listen,listen=_query$listen===void 0?false:_query$listen,parseDates=query.parseDates,isCollectionGroup=query.isCollectionGroup,_query$ignoreFirestor=query.ignoreFirestoreDocumentSnapshotField,ignoreFirestoreDocumentSnapshotField=_query$ignoreFirestor===void 0?true:_query$ignoreFirestor;var _options$refreshInter=options.refreshInterval,refreshInterval=_options$refreshInter===void 0?listen?0:undefined:_options$refreshInter,_options$refreshWhenH=options.refreshWhenHidden,refreshWhenHidden=_options$refreshWhenH===void 0?listen?false:undefined:_options$refreshWhenH,_options$refreshWhenO=options.refreshWhenOffline,refreshWhenOffline=_options$refreshWhenO===void 0?listen?false:undefined:_options$refreshWhenO,_options$revalidateOn=options.revalidateOnFocus,revalidateOnFocus=_options$revalidateOn===void 0?listen?false:undefined:_options$revalidateOn,_options$revalidateOn2=options.revalidateOnReconnect,revalidateOnReconnect=_options$revalidateOn2===void 0?listen?false:undefined:_options$revalidateOn2;var swrOptions=_objectSpread({},options,{refreshInterval:refreshInterval,refreshWhenHidden:refreshWhenHidden,refreshWhenOffline:refreshWhenOffline,revalidateOnFocus:revalidateOnFocus,revalidateOnReconnect:revalidateOnReconnect});var memoQueryString=(0,_react.useMemo)(function(){return JSON.stringify({where:where,endAt:endAt,endBefore:endBefore,startAfter:startAfter,startAt:startAt,orderBy:orderBy,limit:limit,isCollectionGroup:isCollectionGroup});},[endAt,endBefore,isCollectionGroup,limit,orderBy,startAfter,startAt,where]);var dateParser=(0,_react.useRef)(parseDates);(0,_react.useEffect)(function(){dateParser.current=parseDates;},[parseDates]);var shouldListen=(0,_react.useRef)(listen);(0,_react.useEffect)(function(){shouldListen.current=listen;});var shouldIgnoreSnapshot=(0,_react.useRef)(ignoreFirestoreDocumentSnapshotField);(0,_react.useEffect)(function(){shouldIgnoreSnapshot.current=ignoreFirestoreDocumentSnapshotField;},[ignoreFirestoreDocumentSnapshotField]);var swr=(0,_swr.default)(path===null?null:[path,memoQueryString],function _callee(path,queryString){var _await$createListener,unsubscribe,initialData,data;return _regenerator.default.async(function _callee$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:if(!shouldListen.current){_context3.next=9;break;}if(unsubscribeRef.current){unsubscribeRef.current();unsubscribeRef.current=null;}_context3.next=4;return _regenerator.default.awrap(createListenerAsync(path,queryString,{parseDates:dateParser.current,ignoreFirestoreDocumentSnapshotField:shouldIgnoreSnapshot.current}));case 4:_await$createListener=_context3.sent;unsubscribe=_await$createListener.unsubscribe;initialData=_await$createListener.initialData;unsubscribeRef.current=unsubscribe;return _context3.abrupt("return",initialData);case 9:_context3.next=11;return _regenerator.default.awrap(getCollection(path,JSON.parse(queryString),{parseDates:dateParser.current,ignoreFirestoreDocumentSnapshotField:shouldIgnoreSnapshot.current}));case 11:data=_context3.sent;return _context3.abrupt("return",data);case 13:case"end":return _context3.stop();}}},null,null,null,Promise);},swrOptions);var mounted=(0,_react.useRef)(false);(0,_react.useEffect)(function(){if(mounted.current)revalidateRef.current();else mounted.current=true;},[listen]);var revalidateRef=(0,_react.useRef)(swr.revalidate);(0,_react.useEffect)(function(){revalidateRef.current=swr.revalidate;});(0,_react.useEffect)(function(){return function(){if(unsubscribeRef.current){unsubscribeRef.current();unsubscribeRef.current=null;}};},[path,listen,memoQueryString]);(0,_react.useEffect)(function(){if(path)_Cache.collectionCache.addCollectionToCache(path,memoQueryString);},[path,memoQueryString]);var data=swr.data,isValidating=swr.isValidating,revalidate=swr.revalidate,mutate=swr.mutate,error=swr.error;var add=(0,_react.useCallback)(function(data){if(!path)return null;var dataArray=Array.isArray(data)?data:[data];var ref=_context4.fuego.db.collection(path);var docsToAdd=dataArray.map(function(doc){return _objectSpread({},doc,{id:ref.doc().id});});if(!listen){mutate(function(prevState){var state=prevState!==null&&prevState!==void 0?prevState:_empty.empty.array;return[].concat((0,_toConsumableArray2.default)(state),(0,_toConsumableArray2.default)(docsToAdd));},false);}var batch=_context4.fuego.db.batch();docsToAdd.forEach(function(_ref6){var id=_ref6.id,doc=(0,_objectWithoutProperties2.default)(_ref6,["id"]);batch.set(ref.doc(id),doc);});return batch.commit();},[listen,mutate,path]);return{data:data,isValidating:isValidating,revalidate:revalidate,mutate:mutate,error:error,add:add,loading:!data&&!error};};exports.useCollection=useCollection;
//# sourceMappingURL=use-swr-collection.js.map